<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>åœ¨ systemd-nspawn å®¹å™¨ä¸‹æ„å»º Armbian é•œåƒæ–‡ä»¶ - æƒ ç‹ä¹‹ä¹¦</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="é€šå¸¸æ„å»º Armbian æ˜¯ä½¿ç”¨ Armbian Linux Build Framework ï¼Œä½†æ˜¯è¿™ä¸ªé¡¹ç›®è¦æ±‚ä½¿ç”¨ Debian æˆ–è€… Ubuntu æ¥è¿è¡Œã€‚æœ€ç®€å•çš„æ–¹æ¡ˆè‡ªç„¶æ˜¯ä½¿ç”¨å¯¹åº”çš„ç³»ç»Ÿæˆ–è€…å®‰è£…è™šæ‹Ÿæœºï¼Œä½†ç°åœ¨æˆ‘ä½¿ç”¨çš„è®¾å¤‡è¿è¡Œçš„æ˜¯ Arch Linux ä¸”ä¸å¸Œæœ›ä½¿ç”¨è™šæ‹Ÿæœºã€‚å› æ­¤é€šè¿‡ä½¿ç”¨ systemd-nspawn å®¹å™¨æ¥è¿è¡Œ Ubuntu(jammy) æ¥æ„å»ºåˆ·å…¥å¼€å‘æ¿çš„é•œåƒæ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¹Ÿåœ¨è¿™è®°å½•ä¸€ä¸‹ã€‚" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="åœ¨ systemd-nspawn å®¹å™¨ä¸‹æ„å»º Armbian é•œåƒæ–‡ä»¶" />
<meta property="og:description" content="é€šå¸¸æ„å»º Armbian æ˜¯ä½¿ç”¨ Armbian Linux Build Framework ï¼Œä½†æ˜¯è¿™ä¸ªé¡¹ç›®è¦æ±‚ä½¿ç”¨ Debian æˆ–è€… Ubuntu æ¥è¿è¡Œã€‚æœ€ç®€å•çš„æ–¹æ¡ˆè‡ªç„¶æ˜¯ä½¿ç”¨å¯¹åº”çš„ç³»ç»Ÿæˆ–è€…å®‰è£…è™šæ‹Ÿæœºï¼Œä½†ç°åœ¨æˆ‘ä½¿ç”¨çš„è®¾å¤‡è¿è¡Œçš„æ˜¯ Arch Linux ä¸”ä¸å¸Œæœ›ä½¿ç”¨è™šæ‹Ÿæœºã€‚å› æ­¤é€šè¿‡ä½¿ç”¨ systemd-nspawn å®¹å™¨æ¥è¿è¡Œ Ubuntu(jammy) æ¥æ„å»ºåˆ·å…¥å¼€å‘æ¿çš„é•œåƒæ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¹Ÿåœ¨è¿™è®°å½•ä¸€ä¸‹ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.megumifox.com/public/posts/build-armbian-in-systemd-nspawn/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-13T20:53:52+08:00" />
<meta property="article:modified_time" content="2024-04-13T20:53:52+08:00" />
<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="åœ¨ systemd-nspawn å®¹å™¨ä¸‹æ„å»º Armbian é•œåƒæ–‡ä»¶"/>
<meta name="twitter:description" content="é€šå¸¸æ„å»º Armbian æ˜¯ä½¿ç”¨ Armbian Linux Build Framework ï¼Œä½†æ˜¯è¿™ä¸ªé¡¹ç›®è¦æ±‚ä½¿ç”¨ Debian æˆ–è€… Ubuntu æ¥è¿è¡Œã€‚æœ€ç®€å•çš„æ–¹æ¡ˆè‡ªç„¶æ˜¯ä½¿ç”¨å¯¹åº”çš„ç³»ç»Ÿæˆ–è€…å®‰è£…è™šæ‹Ÿæœºï¼Œä½†ç°åœ¨æˆ‘ä½¿ç”¨çš„è®¾å¤‡è¿è¡Œçš„æ˜¯ Arch Linux ä¸”ä¸å¸Œæœ›ä½¿ç”¨è™šæ‹Ÿæœºã€‚å› æ­¤é€šè¿‡ä½¿ç”¨ systemd-nspawn å®¹å™¨æ¥è¿è¡Œ Ubuntu(jammy) æ¥æ„å»ºåˆ·å…¥å¼€å‘æ¿çš„é•œåƒæ–‡ä»¶ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä¹Ÿåœ¨è¿™è®°å½•ä¸€ä¸‹ã€‚"/>
<script src="https://blog.megumifox.com/public/js/feather.min.js"></script>
	
	
        <link href="https://blog.megumifox.com/public/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://blog.megumifox.com/public/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://blog.megumifox.com/public/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css"  disabled />
	

	
	

	
	
	
	

       
       
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HM61C25V9Q"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-HM61C25V9Q', { 'anonymize_ip': false });
}
</script>

       

</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://blog.megumifox.com/public/">æƒ ç‹ä¹‹ä¹¦</a>
	</div>
	<nav>
		
		<a href="/public/">Home</a>
		
		<a href="/public/posts">All posts</a>
		
		<a href="/public/topics">Topics</a>
		
		<a href="/public/about">About</a>
		
		<a href="/public/friends">Friends</a>
		
		| <span id="dark-mode-toggle" onclick="toggleTheme()"></span>
		<script src="https://blog.megumifox.com/public/js/themetoggle.js"></script>
		
	</nav>

</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">åœ¨ systemd-nspawn å®¹å™¨ä¸‹æ„å»º Armbian é•œåƒæ–‡ä»¶</h1>
			<div class="meta">Posted on Apr 13, 2024</div>
		</div>
		

		<section class="body">
			<p>ç®€å•çš„æ¥è¯´å°±æ˜¯åˆ›å»ºä¸ª systemd-nspawn çš„å®¹å™¨ï¼Œç„¶åè·‘å°±å®Œäº‹äº†ã€‚ä½†é—®é¢˜è¿œè¿œæ²¡æœ‰è¿™ä¹ˆç®€å•ï¼ˆx</p>
<h2 id="0x00-å‰è¨€éœ€æ±‚">0x00 å‰è¨€/éœ€æ±‚</h2>
<p>æœ€è¿‘ä¹°äº†ä¸ªå°ç©å…·ï¼Œè¿™ä¸ªå¼€å‘æ¿å‘¢æ²¡æœ‰ Armbian å®˜æ–¹çš„é¢„æ„å»ºæ”¯æŒï¼ˆå°±æ˜¯ä¸èƒ½ç›´æ¥ä¸‹åˆ° Armbian æ„å»ºå¥½çš„é•œåƒï¼‰ï¼Œåªèƒ½æ‰‹åŠ¨ç”¨ Armbian Linux Build Framework æ¥æ„å»ºéœ€è¦çš„å¼€å‘æ¿é•œåƒæ–‡ä»¶ã€‚é—®é¢˜æ¥äº†ï¼Œæ­£å¦‚é¢„è§ˆæ‰€å†™çš„ï¼Œä½¿ç”¨è¿™ä¸ªæ„å»ºå·¥å…·éœ€è¦ä½¿ç”¨ Debian æˆ– Ubuntu ï¼Œä½†æˆ‘ç°åœ¨ä½¿ç”¨çš„ç³»ç»Ÿæ˜¯ Arch Linux ï¼Œæ²¡æœ‰åŠæ³•ç›´æ¥è¿è¡Œè¿™ä¸ªä¸œè¥¿ã€‚å½“ç„¶å¯ä»¥ç”¨ä»–ä»¬æä¾›çš„å…¶ä¸­ä¸€ä¸ªæ–¹æ³•ä½¿ç”¨ docker ï¼Œä½†è¿™æ ·ä¹Ÿå¤ªä¸ä¼˜é›…äº†ã€‚è¿˜ä¸å¦‚ç›´æ¥èµ·ä¸ª systemd-nspawn å®¹å™¨æ¥çš„æ–¹ä¾¿ï¼Œæ‰€æœ‰å°±æœ‰äº†è¿™ä¸ªè®°å½•ã€‚</p>
<h2 id="0x01-å‡†å¤‡å·¥ä½œ">0x01 å‡†å¤‡å·¥ä½œ</h2>
<p>æ—¢ç„¶è¦ç”¨ systemd-nspawn äº†ï¼Œé‚£æˆ‘ä»¬çš„å®¿ä¸»å½“ç„¶éœ€è¦ä¸€ä¸ªä½¿ç”¨ systemd <del><del>æŠŠåº•è£¤å–æ‰</del></del> çš„å‘è¡Œç‰ˆï¼Œå¥½è¦å‡†å¤‡ä¸€ä¸ª Debian æˆ–è€… Ubuntu çš„ rootfsã€‚å½“ç„¶ç›´æ¥ debootstrap ä¸€ä¸ªå°±è¡Œã€‚<br>
æ³¨æ„ï¼š</p>
<blockquote>
<p>systemd-nspawn è¦æ±‚å®¹å™¨ä¸­çš„ä½œæ¥­ç³»çµ±ä»¥ PID 1 é‹è¡Œsystemd initï¼Œä¸¦ä¸” systemd-nspawn è¦å®‰è£åœ¨å®¹å™¨ä¸­ã€‚ç‚ºäº†å®Œå–„ä¾è³´ï¼Œéœ€ç¢ºä¿åœ¨å®¹å™¨ä¸­å®‰è£ debian è»Ÿä»¶åŒ… systemd-containerï¼Œdebian åŒ… systemd-container ä¾è³´ dbusï¼Œä½†æ˜¯ dbus ä¸æœƒè¢«é»˜èªå®‰è£ã€‚æ‰€ä»¥é‚„è¦ç¢ºä¿ dbus æˆ– dbus-broker é€™äº› debian åŒ…è¢«å®‰è£åœ¨å®¹å™¨å…§ç³»çµ±ä¸­ã€‚</p>
</blockquote>
<p>ç›´æ¥ debootstrap ä¸€ä¸ª Ubuntu(jammy) è¿™é‡Œå®¹å™¨çš„åç§°ä¸º ubuntuï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># debootstrap --include=dbus-broker,systemd-container --components=main,universe jammy ubuntu &#34;http://archive.ubuntu.com/ubuntu/&#34;
</span></span></code></pre></div><p>åœ¨åˆ›å»ºå¥½ä¹‹åï¼Œéœ€è¦ç»™ root ç”¨æˆ·ä¸€ä¸ªå¯†ç ï¼Œå› ä¸º Debian å’Œ Ubuntu ä¸æœƒåœ¨é¦–æ¬¡ç™»éŒ„æ™‚ç„¡å¯†ç¢¼ç™»éŒ„ã€‚<br>
åˆ›å»º root å¯†ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># systemd-nspawn -D ubuntu
</span></span><span style="display:flex;"><span># passwd
</span></span><span style="display:flex;"><span># logout
</span></span></code></pre></div><p>è¿™æ ·å°±åˆ›å»ºå¥½ root ç”¨æˆ·çš„å¯†ç äº†ã€‚<br>
æ¥ç€å¯åŠ¨å®¹å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># systemd-nspawn -b -D ubuntu
</span></span></code></pre></div><p>åœ¨ä¸€æ®µæ»šå±è¿‡åï¼Œæˆ‘ä»¬å°±çœ‹è§ä¸‹é¢è¿™æ ·çš„ä¸œè¥¿ã€‚ï¼ˆYume æ˜¯æˆ‘çš„æœºå™¨åï¼‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Ubuntu 22.04 LTS Yume console
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Yume login: 
</span></span><span style="display:flex;"><span>Password:
</span></span></code></pre></div><p>æ¥ç€ç”¨ root ç”¨æˆ·ç™»é™†è¿›å»ï¼Œç»§ç»­å®‰è£…éœ€è¦çš„è½¯ä»¶ä»¥åŠé…ç½®ç¯å¢ƒã€‚éœ€è¦å®‰è£… git å’Œ sudo å¹¶åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·å¹¶ä¸”èµ‹äºˆè¯¥ç”¨æˆ· sudo çš„æƒé™ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># apt update
</span></span><span style="display:flex;"><span># apt install git sudo
</span></span><span style="display:flex;"><span># adduser ubuntu
</span></span><span style="display:flex;"><span># usermod -aG sudo ubuntu
</span></span><span style="display:flex;"><span># logout
</span></span></code></pre></div><p>è‡³æ­¤éœ€è¦çš„å®¹å™¨å·²ç»å‡†å¤‡å¥½äº†ï¼</p>
<h2 id="0x02-æ„å»ºé•œåƒ">0x02 æ„å»ºé•œåƒ</h2>
<p>åˆ‡æ¢è‡³åˆšåˆšæ–°å»ºçš„ ubuntu ç”¨æˆ·ï¼ŒæŒ‰ç…§<a href="https://docs.armbian.com/Developer-Guide_Build-Preparation/">æ–‡æ¡£</a>çš„æŒ‡å¼•å¼€å§‹å¯åŠ¨å¹¶æ„å»ºå¯¹åº”çš„é•œåƒæ–‡ä»¶ã€‚å› ä¸ºå·²ç»æ˜¯ç”¨å®¹å™¨äº†ï¼Œæ²¡å¿…è¦å†ç”¨ docker äº†ï¼Œå› æ­¤åŠ ä¸Š<code>PREFER_DOCKER=no</code> ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ git clone --depth=1 --branch=main https://github.com/armbian/build  
</span></span><span style="display:flex;"><span>$ cd build  
</span></span><span style="display:flex;"><span>$ ./compile.sh PREFER_DOCKER=no 
</span></span></code></pre></div><p>å¯¹å°±è¿™ä¹ˆç®€å•ï¼</p>
<h2 id="0x03-é‡åˆ°é—®é¢˜">0x03 é‡åˆ°é—®é¢˜</h2>
<p>ä½†å¾ˆå¿«å°±é‡åˆ°æç¤ºæ‰¾ä¸åˆ° loop è®¾å¤‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[ğŸ”¨]   The partition table has been altered.
</span></span><span style="display:flex;"><span>[ğŸ”¨]   Syncing disks.
</span></span><span style="display:flex;"><span>find: â€˜/dev/loop*â€™: No such file or directory
</span></span><span style="display:flex;"><span>Usage: grep [OPTION]... PATTERNS [FILE]...
</span></span><span style="display:flex;"><span>Try &#39;grep --help&#39; for more information.
</span></span></code></pre></div><p>å’Œ <code>check_loop_device_internal</code> å‘½ä»¤æ‰§è¡Œå¤±è´¥çš„æç¤º</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[ğŸš¸] Command failed, retrying in 5s [ check_loop_device_internal  ]
</span></span><span style="display:flex;"><span>[ğŸš¸] Command failed 5 times, giving up [ check_loop_device_internal  ]
</span></span><span style="display:flex;"><span>[ğŸ’¥] error! [ Device node  does not exist after 5 tries.  ]
</span></span><span style="display:flex;"><span>[ğŸ’¥] Cleaning up [ please wait for cleanups to finish ]
</span></span></code></pre></div><p>è¿™ä¸ªé—®é¢˜æ˜¯ç”±äºåœ¨å®¹å™¨é‡Œé¢æ²¡æœ‰è¶³å¤Ÿçš„æƒé™åˆ›å»º loop è®¾å¤‡ã€‚æ”¾ç‹—æœç´¢äº†ä¸€ä¸‹ï¼Œæ‰¾åˆ°ä¸€ä¸ªç›¸å…³çš„ï¼Œ<a href="https://gist.github.com/ag88/05245121cce37cb8f029424a20752e35">Building Armbian using Ubuntu (jammy) in a systemd-nspawn container</a>[1]ï¼Œæ€è·¯æ˜¯ç»™å®¹å™¨æƒé™å»åˆ›å»ºè®¾å¤‡ï¼Œå¹¶ä¸”é…åˆä¿®æ”¹æ„å»ºè„šæœ¬ã€‚<br>
åœ¨å®¿ä¸»è®¾å¤‡ä¸Šé‡æ–°ç”¨ä¸‹é¢å‘½ä»¤è¿è¡Œ systemd-nspawn å®¹å™¨,ç»™å®¹å™¨ MKNOD æƒé™ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># systemd-nspawn -b --capability=CAP_MKNOD \
</span></span><span style="display:flex;"><span>        --property=DeviceAllow=&#34;block-loop rwm&#34; \
</span></span><span style="display:flex;"><span>        --property=DeviceAllow=&#34;block-blkext rwm&#34; \
</span></span><span style="display:flex;"><span>        --property=DeviceAllow=&#34;/dev/loop-control rwm&#34; \
</span></span><span style="display:flex;"><span>        -D /opt/armbian-build 
</span></span></code></pre></div><p>ç»™äº†æƒé™è¿˜ä¸å¤Ÿè¿˜éœ€è¦æ¥ç€ç»™æ„å»ºè„šæœ¬æ‰“ patch è®©æ„å»ºè„šæœ¬å¯ä»¥åˆ›å»º loop è®¾å¤‡ï¼Œå› ä¸ºä¸Šé¢çš„é“¾æ¥[1]æ—¶é—´æœ‰ç‚¹ä¹…äº†ï¼Œæ„å»ºè„šæœ¬å’Œä»¥å‰çš„æœ‰éƒ¨åˆ†ä¿®æ”¹å·²ç»å¯¹ä¸ä¸Šäº†å› æ­¤éœ€è¦å¯¹ patch ä¿®æ”¹ã€‚<br>
ä¸‹é¢æ˜¯ä¿®æ”¹å¥½çš„<a href="/public/file/build.patch">patch</a>çš„å†…å®¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>diff <span style="color:#f92672">--</span>git a<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>loop<span style="color:#f92672">.</span>sh b<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>loop<span style="color:#f92672">.</span>sh
</span></span><span style="display:flex;"><span>index <span style="color:#ae81ff">68</span>a2f02<span style="color:#f92672">..</span>df08e09 <span style="color:#ae81ff">100644</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> a<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>loop<span style="color:#f92672">.</span>sh
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> b<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>loop<span style="color:#f92672">.</span>sh
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">3</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">63</span> <span style="color:#960050;background-color:#1e0010">@@</span> function free_loop_device_retried() {
</span></span><span style="display:flex;"><span> 	fi
</span></span><span style="display:flex;"><span> 	losetup <span style="color:#f92672">-</span>d <span style="color:#e6db74">&#34;${1}&#34;</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>function create_loop_devices() {
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span> test <span style="color:#f92672">-</span>e <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span>loop<span style="color:#f92672">-</span>control; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  display_alert <span style="color:#e6db74">&#34;creating loop control device&#34;</span> <span style="color:#e6db74">&#34;/dev/loop-control&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  run_host_command_logged mknod <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span>loop<span style="color:#f92672">-</span>control c <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">237</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	local i
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">2</span> <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">4</span> <span style="color:#ae81ff">5</span> <span style="color:#ae81ff">6</span> <span style="color:#ae81ff">7</span> <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">9</span> <span style="color:#ae81ff">10</span> <span style="color:#ae81ff">11</span> <span style="color:#ae81ff">12</span> <span style="color:#ae81ff">13</span> <span style="color:#ae81ff">14</span> <span style="color:#ae81ff">15</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span> test <span style="color:#f92672">-</span>e <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span>loop<span style="color:#f92672">$</span>{i}; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  display_alert <span style="color:#e6db74">&#34;creating loop device&#34;</span> <span style="color:#e6db74">&#34;/dev/loop${i}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  run_host_command_logged mknod <span style="color:#f92672">/</span>dev<span style="color:#f92672">/</span>loop<span style="color:#f92672">$</span>{i} b <span style="color:#ae81ff">7</span> <span style="color:#f92672">$</span>{i}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	done
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>function dolosetup(){
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	local loopdev<span style="color:#f92672">=$</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	local image_file<span style="color:#f92672">=$</span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> test <span style="color:#f92672">-</span>z <span style="color:#e6db74">&#34;${image_file}&#34;</span>; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  exit_with_error <span style="color:#e6db74">&#34;image file not specified&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span> test <span style="color:#f92672">-</span>e <span style="color:#f92672">$</span>image_file; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  exit_with_error <span style="color:#e6db74">&#34;image file ${image_file} not found&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> test <span style="color:#f92672">-</span>z <span style="color:#e6db74">&#34;${loopdev}&#34;</span>; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  exit_with_error <span style="color:#e6db74">&#34;loop device not specified&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	display_alert <span style="color:#e6db74">&#34;loop device&#34;</span> <span style="color:#e6db74">&#34;${loopdev}&#34;</span> <span style="color:#e6db74">&#34;debug&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span> test <span style="color:#f92672">-</span>e <span style="color:#f92672">$</span>{loopdev}; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  exit_with_error <span style="color:#e6db74">&#34;image file ${loopdev} not found&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	run_host_command_logged losetup <span style="color:#f92672">-</span>P <span style="color:#f92672">$</span>{loopdev} <span style="color:#f92672">$</span>{image_file}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#75715e">#check that loop device is linked</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	local lochk<span style="color:#f92672">=$</span>(losetup <span style="color:#f92672">-</span>j <span style="color:#f92672">$</span>{image_file} <span style="color:#f92672">|</span>sed <span style="color:#e6db74">&#39;s/: .*$//&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> test <span style="color:#e6db74">&#34;${lochk}&#34;</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;${loopdev}&#34;</span> ; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  exit_with_error <span style="color:#e6db74">&#34;losetup unable to setup ${loopdev}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#75715e"># drop the first line, as this is our loopdev itself, but we only want the child partitions</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	local partitions<span style="color:#f92672">=$</span>(lsblk <span style="color:#f92672">--</span>raw <span style="color:#f92672">--</span>output <span style="color:#e6db74">&#34;MAJ:MIN&#34;</span> <span style="color:#f92672">--</span>noheadings <span style="color:#f92672">$</span>{loopdev} <span style="color:#f92672">|</span> tail <span style="color:#f92672">-</span>n <span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">if</span> echo <span style="color:#f92672">$</span>{partitions} <span style="color:#f92672">|</span> egrep <span style="color:#f92672">-</span>q <span style="color:#e6db74">&#34;[[:digit:]]:[[:digit:]].*&#34;</span> ; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  local counter<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> <span style="color:#f92672">$</span>partitions; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	    local maj<span style="color:#f92672">=$</span>(echo <span style="color:#f92672">$</span>i <span style="color:#f92672">|</span> cut <span style="color:#f92672">-</span>d: <span style="color:#f92672">-</span>f1)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	    local min<span style="color:#f92672">=$</span>(echo <span style="color:#f92672">$</span>i <span style="color:#f92672">|</span> cut <span style="color:#f92672">-</span>d: <span style="color:#f92672">-</span>f2)
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	    display_alert <span style="color:#e6db74">&#34;partition&#34;</span> <span style="color:#e6db74">&#34;${loopdev}p${counter} b ${maj} ${min}&#34;</span> <span style="color:#e6db74">&#34;debug&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	    <span style="color:#66d9ef">if</span> [ <span style="color:#f92672">!</span> <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#34;${loopdev}p${counter}&#34;</span> ]; then
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	      display_alert <span style="color:#e6db74">&#34;create partition loop device&#34;</span> <span style="color:#e6db74">&#34;${loopdev}p${counter} b ${maj} ${min}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	      mknod <span style="color:#f92672">$</span>{loopdev}p<span style="color:#f92672">$</span>{counter} b <span style="color:#f92672">$</span>{maj} <span style="color:#f92672">$</span>{min}
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	    fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	    counter<span style="color:#f92672">=$</span>((counter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  done
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	  exit_with_error <span style="color:#e6db74">&#34;cannot get MAJ:MIN ${maj}:${min} from lsblk&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	fi
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>}
</span></span><span style="display:flex;"><span>diff <span style="color:#f92672">--</span>git a<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>partitioning<span style="color:#f92672">.</span>sh b<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>partitioning<span style="color:#f92672">.</span>sh
</span></span><span style="display:flex;"><span>index cd614eb<span style="color:#f92672">..</span><span style="color:#ae81ff">32</span>b9825 <span style="color:#ae81ff">100644</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">---</span> a<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>partitioning<span style="color:#f92672">.</span>sh
</span></span><span style="display:flex;"><span><span style="color:#f92672">+++</span> b<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>functions<span style="color:#f92672">/</span>image<span style="color:#f92672">/</span>partitioning<span style="color:#f92672">.</span>sh
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">215</span>,<span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">215</span>,<span style="color:#ae81ff">7</span> <span style="color:#960050;background-color:#1e0010">@@</span> function prepare_partitions() {
</span></span><span style="display:flex;"><span> 	exec {FD}<span style="color:#f92672">&gt;</span> <span style="color:#f92672">/</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span>lock<span style="color:#f92672">/</span>armbian<span style="color:#f92672">-</span>debootstrap<span style="color:#f92672">-</span>losetup
</span></span><span style="display:flex;"><span> 	flock <span style="color:#f92672">-</span>x <span style="color:#f92672">$</span>FD
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	create_loop_devices
</span></span><span style="display:flex;"><span> 	declare <span style="color:#f92672">-</span>g LOOP
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># replace losetup --find with own function and do 10 cycles</span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># losetup always return 1st free loop device and in parallel build,</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@@</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">234</span>,<span style="color:#ae81ff">7</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">235</span>,<span style="color:#ae81ff">8</span> <span style="color:#960050;background-color:#1e0010">@@</span> function prepare_partitions() {
</span></span><span style="display:flex;"><span> 	CHECK_LOOP_FOR_SIZE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;no&#34;</span> check_loop_device <span style="color:#e6db74">&#34;$LOOP&#34;</span> <span style="color:#75715e"># initially loop is zero sized, ignore it.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#75715e">#--partscan is using to force the kernel for scaning partition table in preventing of partprobe errors</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span>	run_host_command_logged losetup <span style="color:#f92672">--</span>partscan <span style="color:#e6db74">&#34;${LOOP}&#34;</span> <span style="color:#e6db74">&#34;${SDCARD}&#34;</span><span style="color:#f92672">.</span>raw
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	<span style="color:#75715e">#run_host_command_logged losetup --partscan &#34;${LOOP}&#34; &#34;${SDCARD}&#34;.raw</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span>	dolosetup <span style="color:#e6db74">&#34;${LOOP}&#34;</span> <span style="color:#e6db74">&#34;${SDCARD}&#34;</span><span style="color:#f92672">.</span>raw
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e"># loop device was grabbed here, unlock</span>
</span></span><span style="display:flex;"><span> 	flock <span style="color:#f92672">-</span>u <span style="color:#f92672">$</span>FD
</span></span></code></pre></div><p>æŠŠ patch æ”¾åˆ° build ç›®å½•ä¸‹é¢ï¼Œç„¶åå†å°è¯•æ„å»ºé—®é¢˜è§£å†³ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ patch -b -p1  &lt; build.patch
</span></span><span style="display:flex;"><span>$ ./compile.sh PREFER_DOCKER=no
</span></span></code></pre></div><h2 id="0x03-ç»“å°¾">0x03 ç»“å°¾</h2>
<p>æ•´ä¸ªè¿‡ç¨‹ä¸‹æ¥ä¹Ÿæ²¡å¤šå°‘ä¸œè¥¿ï¼Œè¿™é‡Œç®—æ˜¯åšä¸ªè®°å½•å§ã€‚å¾ˆç®€å•èµ·ä¸ªå®¹å™¨ï¼Œè¿è¡Œè„šæœ¬ï¼Œç„¶åå› ä¸ºå®¹å™¨æƒé™çš„é—®é¢˜ï¼Œéœ€è¦å¯¹æ„å»ºè„šæœ¬æ‰“ä¸ªå°å°çš„è¡¥ä¸ã€‚è¿™é‡Œä¹Ÿè¦æ„Ÿè°¢ <a href="https://t.me/FQEGG">@FQEGG</a> çš„å¸®åŠ©ï¼Œå› ä¸ºä¹‹å‰ç¡®å®æ²¡æ€ä¹ˆç”¨è¿‡<code>systemd-nspawn</code>ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿç»™æˆ‘æä¾›äº†ä¸å°‘çš„å¸®åŠ©ï¼Œé¡ºä¾¿å¸®å¿™æµ‹è¯•äº†è¿™ä¸ªæ–¹æ³•çš„å¯è¡Œæ€§ã€‚<br>
å˜›ï¼Œéƒ½ç”¨ä¸Š systemd-nspawn äº†ï¼Œè¿™é‡Œå†å®‰åˆ©ç‚¹å¥½ç©çš„å§ -&gt; <a href="https://kirikira.moe/post/49/">åˆ«æƒ¦è®°ä½ é‚£All In BOOMäº†ï¼Œæ¥ç”¨å®¹å™¨è·‘è½¯è·¯ç”±å§</a>ã€‚</p>
<hr>
<h2 id="åƒè€ƒè³‡æ–™ä»¥åŠéˆæ¥">åƒè€ƒè³‡æ–™ä»¥åŠéˆæ¥</h2>
<p>[1] <a href="https://gist.github.com/ag88/05245121cce37cb8f029424a20752e35">https://gist.github.com/ag88/05245121cce37cb8f029424a20752e35</a><br>
[2] <a href="https://docs.armbian.com/Developer-Guide_Build-Preparation/">https://docs.armbian.com/Developer-Guide_Build-Preparation/</a><br>
[3] <a href="https://wiki.archlinux.org/title/Systemd-nspawn">https://wiki.archlinux.org/title/Systemd-nspawn</a><br>
[ğŸ”¨] <a href="https://kirikira.moe/post/49/">https://kirikira.moe/post/49/</a></p>

		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/public/tags/armbian">armbian</a></li>
					
					<li><a href="/public/tags/systemd-nspawn">systemd-nspawn</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		<div id="disqus_thread"></div>
<script type="text/javascript">
    (function () {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        var disqus_shortname = 'megumifox';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="/public/index.xml" rel="me" title=""><i data-feather="rss"></i></a>
    <a class="border"></a><a class="soc" href="https://github.com/MarvelousBlack" rel="me" title=""><i data-feather="github"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2024  Â© æƒ ç‹ä¹‹ä¹¦ |  <a
      href="https://github.com/athul/archie">Archie Theme</a> | æ‰€æœ‰çš„æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡ä½¿ç”¨ <a href="https://blog.megumifox.com/public/license">CC BY-NC-SA 4.0</a>ã€‚
  </div>
</footer><script>
  feather.replace()
</script></div>
    </body>
</html>
