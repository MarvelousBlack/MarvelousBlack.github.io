---
title: "Canokey NFC-A & Canokey Pigeon 開箱"
date: 2022-01-26T13:37:26+08:00
draft: true
description: "在羣友安利下，我購入了 Canokey。恩，這是一個硬件密鑰，支援 U2F / FIDO2 、 OpenPGP Card V3.4 、 PIV 還有 OTP （one time password），而且價格十分低廉，那就買回來試試。嘛，至於爲什麼標題有兩個型號，那純粹是我從去年（2021）一直拖到今年（2022），新的正式版都發佈了，於是一起寫。"
topics:
  - 杂乱的笔记
tags:
  - canokey
  - u2f
  - gpg
---
這篇東西從去年（2021）3月寫到今年（2022）年1月，咕了十分久，所以將兩個產品寫一起了。之前已經寫了一大段文字,~~讓我想想當時寫了寫什麼玩意~~,因此按照時間順序來介紹兩個 key，分別寫出當時遇到的問題和新的 key 遇到的問題。  
嘛，先說結論（基於正式發售的 Canokey Pigeon），如果你想馬上買，那不太推薦馬上購買，雖然價格低廉，USB部分工作正常，影響使用的大問題沒有，但如果真的要馬上搞一個，那建議等等~~（反正寫這篇東西的時候你也買不到了）~~，等他把那些零碎的問題都修了再買，很多問題都是軟件問題，而這種硬件密鑰都是不能更新固件的，你也不希望買回來遇到一堆小問題煩心，特別是那種升級固件就可以修好的軟件問題。如果你是 **衝着它有 NFC 功能** 就去買的話，那我完全不推薦，建議把這個 NFC 當作不存在，首先在 iPhone12 上存在 NFC 讀不到的問題 ，而其他的 Android 手機在很多存在功率不夠（？）的問題，會出現讀取不到，或者要搓半天去找到一個好一點的位置（部分手機是 key 平行於線圈的位置）才能正確識別，NFC 部分的體驗就非常的差了，和沒有差不多。  
當然我寫這篇東西列這麼多問題也不是說這東西不好，畢竟這麼多的開發者付出了不少精力在這上面不斷的完善和修復問題，還是要支持一下的~~（畢竟那是真的便宜）~~，而且他們反應非常的快，只是到我現在寫的時候，我能買到的正式發售的第一批產品 Canokey Pigeon 還存在不少問題，所以才建議等等,相信他們的速度很快就會解決這些問題，讓我們見到一個更完善的 Canokey 。

## 0x00 買！
我之前是沒接觸過硬件密鑰的，然後看羣友推薦然後就去瞭解了一下。看着很多操作上很方便，特別是在兩步驗證的時候，只需要輕輕一點就完成了，於是十分想要一個。搜了一些 yubikey ，emmm ，沒錢！而且看起來搞回來還挺麻煩的，遂放棄。你問我爲什麼不去搞一條那種用 stm32 的那種開源的？先不說 stm32 可以把裏面的存儲的東西扣出來這個問題，主要是這個東西沒有成品而且我也懶得搞。對！就是懶！雖然說很簡單，畫個板子焊接一下然後燒個固件，但我就是不想動。雖然這看起來和我之前搞的東西的風格有點不像，但確實不想折騰，就想買個可以用的成品直接用。  
在一次偶然的機會和某羣友聊了一下之後，有人告訴我有個東西叫 Canokey，是羣友開發的一個不錯的硬件密鑰。恩，隨便瞭解了一下。這東西有個兩個版本，一個是 stm32 的開源版本，另外一個是使用安全芯片的閉源版本。正好我去看的時候，閉源版準備有成品可以賣了(實際上就是小規模的測試版），反正我也只是想買個能用的成品，那就試試吧。過了沒多久（？），第一批的早鳥版就發售了 只需要 79CNY 就可以入手一條了。因爲當時哪怕知道了這種東西最好是弄兩條，一條作爲主要使用的，另一條作爲備份，但想着這東西應該會有不少的問題，所以還是先買了一條試試水（果然後面真的不少問題）。嘛，已經知道是測試版所以也做好了心裏準備，買回來能工作就謝天謝地了（X。  
嘛，因爲第一批發售的時候是在羣裏面發消息，而且都是手工生產產量十分的少，加上當時我不是一直盯着羣，我看見消息的時候就已經剩下無滴膠版本了，想了一下隨便搞個湊合用就好了，於是就下單了。後面店主私聊我和我說算錯數量了，滴膠還有一個，可以直接發，問我要不要換，我想着隨便，然後就換成了滴膠版。

## 0x01 Canokey NFC-A
不知道怎麼介紹，隨便抄點項目頁面上的內容好了（
在項目中，它提到了它支援以下的協議
```
U2F / FIDO2 with ed25519 and HMAC-secret
OpenPGP Card V3.4, Supported Algorithm List
PIV (NIST SP 800-73-4)
HOTP / TOTP
NDEF
```
這應該涵蓋了許多人的應用場景。  
Canokey 分爲開源版和閉源版。閉源版和開源版共用核心實現，但閉源版密碼學運算部分由於使用的芯片有 NDA 所以不能開源，所以閉源版的固件只有口頭保證 Conokey-core 是和開源的相同。 大部分東西都可以在 [github.com/canokeys](https://github.com/canokeys/) 中找到。  
至於那個開源版，用的是 stm32 ，前面已經提到了可以把內容扣出來了，所以玩玩還是可以的。Z 某已經經歷過開源版 Canokey 放桌上然後被人當面把 key 扣出來的慘劇。

# 0x02 Canokey NFC-A 開箱
等了幾天，終於拿到了，是一個紙袋包着，拆開裏面還有一個郵政的小塑料袋裝着，保護還是做的挺好的。掏出袋子就可以看見一個巨大的圈九。（ \バガ/ \バガ/　腦子裏面瞬間有聲音了）

# 0x03 早起的鳥兒有蟲喫（x
早鳥版嘛，很正常就是有蟲（BUG）喫。畢竟是測試版，遇到什麼問題都不奇怪。我買到的這一批同時也有一小部分是抽獎的形式送出的，所以有一部分人很早就拿到了這第一批的key。在這批人裏面有人報告了在蘋果設備上無法使用的問題。前文中我沒有提及一件事就是，其實我買的時候就已經知道了有部分問題，只是想着我又沒有蘋果設備，應該不影響我用吧，反正湊合用。但這個問題實際上是 USB 協商的時候出現問題，在某些控制器上無法 config ，並不是蘋果設備獨有的問題。我直接插我現有的電腦上，手機上都沒有問題，它工作，想着我這應該不會遇到這種不能用影響我使用的問題。直到我往筆記本上掛了一個很早很早前買的 usb 2.0 的 hub，然後把 key 插到 hub 上，發現它不工作了並且 dmesg 上會出現：
```
[  153.776041] usb 2-2.2: can't set config #1, error -32
```
額，沒想到遇到了影響使用的問題。你可能會說，前面說了直接插不會有問題，那就不插 hub 上直接插筆記本上就好了啊。但是我用的筆記本上只有兩個 USB A 而且沒其他的口，也就是說我直接插那上面我就會佔掉一個 usb 口，而且那個口還是 usb3.0 ，如果我還要插其他的儲存設備那就沒 USB 3.0 的接口用了，所以這算很影響使用問題。這個固件問題（還好不是硬件問題） ~~（土製USB）~~ ，而 Canokey NFC-A 不能升級固件的，沒辦法。只能問店主怎麼處理，店主（同時也是開發者）說可以退還，店主還挺好人的，包了退換的郵費，而且修復的很快（其實有人在我發現這個問題之前就已經遇到了，只是他們的更明顯直接插上就出現這個提示）並且在第二版的早鳥版中修復了這個問題。  
這裏插一句，如果我沒記錯的話，這第一批的 key 插着的時候重啓計算機（就是一直上電然後 reset ）會出現不識別的問題，因爲是換了很久之後才想起來的所以就沒對應的 log 和錯誤提示了。（這句話寫於2022年1月，而換 key 的時候是應該是2021年3月，所以是不是記錯了我也記不清了，因爲換回來的第二版已經沒有這個問題了）

# 0x03 第二批 Canokey NFC-A 換回來了
再次開箱：

這次固件更新到了`1.2-0-g2f1f180e` usb config 的問題修好了，也就是說可以正常的使用了,至少在我手上有的設備上不會再遇到不能用的情況了。

# 0x04 個人的用途和感受



# 0x05 目前還存在的問題
目前已經賣出去的早鳥版都有一個問題，具體參見[1](https://github.com/Yubico/libfido2/issues/322)，簡單說就是那個該死的不等於3[2](https://github.com/canokeys/canokey-core/blob/4cacb73ec275c3fa32da67305e9f5e4884fba05d/applets/ctap/ctap-parser.c#L407)（x,導致了和 FIDO 2.0 的要求不一樣，才出現了這個問題。這個問題也很好解決，因爲 canokey 的固件已經合併了提交，所以買新的就好了（

# 0x06 長期使用下來的感受
首先，滴膠並不是很好的防護，雖然板子還是完好的包住了。但是滴膠在日常的使用中已經出現了比較深的劃痕，而且很不耐刮，大大的影響觀感。當然滴膠版僅僅只是早鳥版的早期處理，問了一下作者，他們說外殼版已經在做了，但似乎一直都沒有恢復生產的跡象。總的來說還是個不錯的產品，希望正式版可以快點發售吧。
